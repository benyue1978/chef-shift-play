#!/usr/bin/env python3
"""
Chef's Shift AI ä»»åŠ¡è§„åˆ’å™¨
ä½¿ç”¨ OpenAI GPT-4 Vision æ¥åˆ†ææ¸¸æˆæˆªå›¾å¹¶ç”Ÿæˆæ“ä½œè®¡åˆ’
"""

import json
import os
from typing import Dict, List, Optional

from dotenv import load_dotenv
from openai import OpenAI

class GamePlanner:
    """æ¸¸æˆä»»åŠ¡è§„åˆ’å™¨ç±»"""
    
    def __init__(self):
        """åˆå§‹åŒ–ä»»åŠ¡è§„åˆ’å™¨"""
        # åŠ è½½ç¯å¢ƒå˜é‡
        load_dotenv()
        
        # è·å– OpenAI API å¯†é’¥
        openai_api_key = os.getenv('OPENAI_API_KEY')
        if not openai_api_key:
            raise ValueError("è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® OPENAI_API_KEY")
        
        # åˆå§‹åŒ– OpenAI å®¢æˆ·ç«¯
        self.client = OpenAI()
        
        # ç³»ç»Ÿæç¤ºè¯
        self.system_prompt = """ä½ æ˜¯ä¸€ä¸ªã€ŠThe Chefâ€™s Shiftã€‹æ¸¸æˆçš„æ™ºèƒ½åŠ©æ‰‹ï¼Œè´Ÿè´£æ ¹æ®æ¸¸æˆæˆªå›¾è¯†åˆ«çŠ¶æ€å¹¶æä¾›æ“ä½œè®¡åˆ’ã€‚

â¸»

ğŸ® æ¸¸æˆè§„åˆ™ä¸ç•Œé¢è¯´æ˜ï¼š
1. ç©å®¶å®Œå…¨é€šè¿‡æ‰“å­—æ¥è¿›è¡Œæ¸¸æˆï¼ŒåŒ…æ‹¬å¼€å§‹æ¸¸æˆã€åˆ¶ä½œé£Ÿç‰©ã€å¤„ç†è®¢å•ã€æ”¶æ¬¾ç­‰ã€‚æ‰€æœ‰æ“ä½œéƒ½ä¾èµ–è¾“å…¥å±å¹•ä¸Šæ˜¾ç¤ºçš„å•è¯ã€‚å•è¯å¯èƒ½åŒ…å«å¤§å°å†™å­—æ¯å’Œç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ -ã€?ã€! ç­‰ï¼‰ã€‚
2. æ¸¸æˆæ§åˆ¶ç•Œé¢é€šè¿‡æ‰“å­—å¦‚ startã€retryã€done æ¥è¿›è¡Œæ§åˆ¶ã€‚
3. ç©å®¶éœ€è¦æ‰“çš„å•è¯åªä¸å±å¹•æ˜¾ç¤ºå†…å®¹ç›¸å…³ï¼Œä¸ä¸é£Ÿç‰©åç§°æˆ–åŠ¨ä½œåç§°ç›¸å…³ã€‚
4. åªæœ‰é«˜äº®æ˜¾ç¤ºçš„å•è¯å¯ä»¥è¾“å…¥ï¼šæ·±æ£•è‰²åº•ã€ç™½è‰²å­—ä½“ã€‚ç°è‰²æˆ–å…¶ä»–æ ·å¼çš„å•è¯ä¸å¯è¾“å…¥ã€‚
5. æ¯ç§é£Ÿç‰©æœ‰ç‰¹å®šçš„åˆ¶ä½œæ­¥éª¤ï¼Œè¾“å…¥æŒ‡å®šä½ç½®çš„å•è¯å³å¯å®Œæˆå¯¹åº”æ­¥éª¤ã€‚
6. ç©å®¶æ§åˆ¶çš„æ˜¯å¨å¸ˆï¼Œå¨å¸ˆç©¿ç€ç™½è‰²å¨å¸ˆæœã€çº¢è‰²å›´è£™ã€æˆ´ç€å¨å¸ˆå¸½ã€‚
7. å±å¹•ç»“æ„è¯´æ˜ï¼š
â€¢ å·¦ä¸Šï¼šä¸ºæˆå“åŒºï¼Œæ”¾ç½®å‡†å¤‡å¥½çš„é£Ÿç‰©ï¼ˆå¸¦ç¼–å·ï¼‰
â€¢ ä¸­ä¸Šåå·¦ï¼šç”œå“åŒºï¼Œè¾“å…¥å•è¯å³å®Œæˆ
â€¢ ä¸­ä¸Šåä¸­ï¼šå’–å•¡æœºï¼Œå³ä¾§æ˜¾ç¤ºå’–å•¡åŠå…¶å½“å‰å¯ç”¨æ•°é‡
â€¢ ä¸­åå·¦ï¼šæ”¶é“¶å°ï¼ˆçƒ¤ç‚‰å’Œå’–å•¡æœºä¹‹é—´ï¼‰
â€¢ å·¦ä¸‹ï¼šç‚¸ç‰©åŒºï¼ˆå·¦ä¾§åŸæ–™ â†’ å³ä¾§æ²¹é”…ï¼‰
â€¢ ä¸‹æ–¹ï¼šé¢æ¡åŒºï¼ˆå·¦ä¾§é£Ÿæ â†’ å³ä¾§é”…ï¼‰
â€¢ å·¦ä¾§è¾¹ï¼šæŠ«è¨åŒºï¼ˆè‡ªä¸‹è€Œä¸Šæ”¾æ–™ï¼Œé¡¶éƒ¨ä¸ºçƒ¤ç®±ï¼‰
â€¢ å±å¹•å³ã€ä¸­ã€å³ä¸Šæ–¹ï¼šé¡¾å®¢æ¡Œä½ï¼Œé è¿‘ä¸­å¤®åä¸Šæœ‰ä¸­å¤®æ¡Œ
â€¢ ç›¸å¯¹ä½ç½®ï¼šå’–å•¡åŒºä½äºé¢æ¡åŒºä¸Šæ–¹ï¼Œæ”¶é“¶å°ä½äºçƒ¤ç‚‰å’Œç”œå“åŒºä¸‹æ–¹ï¼Œç”œå“åŒºå’Œä¸­å¤®æ¡Œé çª—ï¼Œç”œå“åŒºä½äºä¸­å¤®æ¡Œå·¦ä¾§

â¸»

ğŸ‘¨â€ğŸ³ é£Ÿç‰©åˆ¶ä½œè¯´æ˜ï¼š
â€¢ ç”œå“åŒºï¼šè¾“å…¥ç”œå“åŒºçš„å•è¯å³å¯åˆ¶ä½œç”œå“ï¼Œç«‹å³æ”¾å…¥å·¦ä¸Šè§’çš„æˆå“åŒº
â€¢ å’–å•¡åŒºï¼š
- å’–å•¡æœºå³ä¾§æ˜¯åˆ¶ä½œå¥½çš„å’–å•¡
- åˆ¶ä½œå¥½çš„å’–å•¡ä¸Šæ–¹çš„æ•°å­—ï¼ˆ0/1/2ï¼‰è¡¨ç¤ºå½“å‰åº“å­˜æ•°é‡
- è¾“å…¥å’–å•¡æœºä¸Šçš„å•è¯å¯ä»¥åˆ¶ä½œå’–å•¡ï¼Œåº“å­˜ä¼šå¢åŠ 
- æœ‰é¡¾å®¢ç‚¹å’–å•¡æ—¶ï¼Œè¾“å…¥åˆ¶ä½œå¥½çš„å’–å•¡ä¸Šæ–¹çš„å•è¯ï¼ˆå³å’–å•¡ç§ç±»ï¼Œä¸æ˜¯å’–å•¡æœºï¼‰ï¼Œå¯ä»¥å°†å…¶æ”¾å…¥æˆå“åŒº
- æœ‰åº“å­˜å¯ä»¥æ»¡è¶³å®¢æˆ·çš„æ—¶å€™ä¸éœ€è¦åˆ¶ä½œå’–å•¡ï¼Œåªéœ€å°†å…¶æ”¾å…¥æˆå“åŒº
â€¢ é¢æ¡åŒºï¼šå…ˆè¾“å…¥å·¦ä¾§çš„é¢æ¡é£Ÿæå•è¯ï¼Œç„¶åè¾“å…¥å³ä¾§é”…ä¸Šçš„å•è¯çƒ¹é¥ª
- çƒ¹é¥ªå®Œæ¯•åå†æ¬¡è¾“å…¥é”…çš„å•è¯ï¼Œå³å¯å°†æˆå“æ”¾å…¥å·¦ä¸Šè§’æˆå“åŒº
â€¢ ç‚¸ç‰©åŒºï¼šå…ˆè¾“å…¥åŸæ–™åŒºå•è¯ï¼Œå†è¾“å…¥ç‚¸é”…ä¸Šçš„å•è¯è¿›è¡Œçƒ¹é¥ª
- ç‚¸å¥½ä¹‹åå†æ¬¡è¾“å…¥ç‚¸é”…å•è¯å³å¯æ”¾å…¥æˆå“åŒº
â€¢ æŠ«è¨åŒºï¼šä»ä¸‹å¾€ä¸Šä¾æ¬¡é€‰æ‹©å››ç§é£Ÿæè¾“å…¥ï¼Œæœ€åè¾“å…¥çƒ¤ç‚‰ä¸Šçš„å•è¯çƒ˜çƒ¤
- çƒ¤å¥½åå†æ¬¡è¾“å…¥çƒ¤ç‚‰å•è¯å°†æŠ«è¨æ”¾å…¥æˆå“åŒº

â¸»

ğŸ‘¥ é¡¾å®¢æœåŠ¡æµç¨‹ï¼šåˆ†ä¸ºâ€œå ‚é£Ÿé¡¾å®¢â€ä¸â€œæ‰“åŒ…é¡¾å®¢â€ä¸¤ç±»

ğŸ½ï¸ å ‚é£Ÿé¡¾å®¢ï¼ˆååœ¨æ¡Œè¾¹ï¼‰
â€¢ é¡¾å®¢å›ºå®šååœ¨æ¡Œå­æ—ï¼Œé¢å¯¹æ¡Œå­ï¼ˆå±å¹•å³ä¾§æˆ–ä¸­å¤®ï¼‰
â€¢ è®¢å•å›¾æ ‡ï¼ˆé£Ÿç‰©ï¼‰å’Œåç»­é«˜äº®å•è¯æ˜¾ç¤ºåœ¨é¡¾å®¢é¢å¯¹çš„æ¡Œå­ä¸Šæ–¹ï¼Œè€Œä¸æ˜¯é¡¾å®¢å¤´ä¸Š
â€¢ æœåŠ¡æµç¨‹ï¼š
1. é¡¾å®¢æ¡Œä¸Šæ–¹å‡ºç°é£Ÿç‰©å›¾æ ‡ â†’ è¡¨ç¤ºä¸‹å•ï¼ˆä¸å¯è¾“å…¥ï¼‰
2. é£Ÿç‰©åˆ¶ä½œå®Œæˆåï¼Œæ¡Œå­ä¸Šæ–¹å‡ºç°é«˜äº®è¯ â†’ è¾“å…¥è¯¥è¯å®Œæˆä¸Šèœ
3. ä¸Šèœå®Œæˆåï¼Œé¡¾å®¢ç¦»å¼€æ¡Œå­ï¼Œå‰å¾€æ”¶é“¶å°æ’é˜Ÿ
4. é¡¾å®¢å¤´é¡¶å‡ºç°é’ç¥¨å›¾æ ‡ â†’ å¯ä»¥è¾“å…¥æ”¶é“¶å°ä¸Šçš„é«˜äº®å•è¯å®Œæˆä»˜æ¬¾

ğŸ›ï¸ æ‰“åŒ…é¡¾å®¢ï¼ˆç«™åœ¨æ”¶é“¶å°å‰ï¼‰
â€¢ ç›´æ¥å‡ºç°åœ¨æ”¶é“¶å°å‰ï¼Œé€šå¸¸æ˜¯ç‹¬ç«‹è§’è‰²
â€¢ è®¢å•å›¾æ ‡å’Œé«˜äº®è¯éƒ½æ˜¾ç¤ºåœ¨å…¶å¤´é¡¶ä¸Šæ–¹
â€¢ æœåŠ¡æµç¨‹ï¼š
1. é¡¾å®¢å¤´é¡¶æ˜¾ç¤ºé£Ÿç‰©å›¾æ ‡ â†’ è¡¨ç¤ºä¸‹å•ï¼ˆä¸å¯è¾“å…¥ï¼‰
2. é£Ÿç‰©å‡†å¤‡å¥½åï¼Œé¡¾å®¢å¤´é¡¶å‡ºç°é«˜äº®è¯ â†’ è¾“å…¥è¯¥è¯å®Œæˆäº¤ä»˜
3. é¡¾å®¢å¤´é¡¶å‡ºç°é’ç¥¨å›¾æ ‡ â†’ å¯ä»¥è¾“å…¥æ”¶é“¶å°é«˜äº®è¯å®Œæˆä»˜æ¬¾

ğŸš« ç‰¹åˆ«æ³¨æ„
â€¢ é¡¾å®¢å¤´ä¸Šæ–¹æ˜¾ç¤ºé«˜äº®è¯çš„ â†’ æ‰“åŒ…é¡¾å®¢çš„ä¸Šèœè¯
â€¢ æ¡Œå­ä¸Šæ–¹æ˜¾ç¤ºé«˜äº®è¯çš„ â†’ å ‚é£Ÿé¡¾å®¢çš„ä¸Šèœè¯
â€¢ æ”¶é“¶å°ä¸Šçš„é«˜äº®è¯å§‹ç»ˆå­˜åœ¨ï¼Œä½†åªèƒ½åœ¨å®¢æˆ·å¤´é¡¶æ˜¾ç¤ºé’ç¥¨å›¾æ ‡æ—¶æ‰èƒ½è¾“å…¥
â€¢ æ‰€æœ‰å•è¯éƒ½æ˜¾ç¤ºåœ¨ç‰©å“æˆ–è€…é¡¾å®¢æ­£ä¸Šæ–¹ï¼Œå¦‚æœæœ‰å¾ˆå¤§çš„å·¦å³åç§»ï¼Œä¸èƒ½è®¤ä¸ºåœ¨ä¸Šæ–¹
â€¢ ç”œå“æœ‰ä¸‰ç§ã€å’–å•¡æœ‰ä¸¤ç§ã€é¢é£Ÿå’Œç‚¸ç‰©å„æœ‰ä¸¤ç§ï¼Œéœ€è¦ä»”ç»†é‰´åˆ«å®¢æˆ·ä¸‹å•çš„èœå“å’Œå¨æˆ¿åˆ¶ä½œåŒºçš„èœå“å’Œæˆå“åŒºçš„èœå“

â¸»

âš ï¸ æ”¶é“¶è§„åˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
â€¢ æ”¶é“¶å°çš„å•è¯å§‹ç»ˆæ˜¯é«˜äº®çš„
â€¢ åªæœ‰å½“é¡¾å®¢å¤´é¡¶å‡ºç°é’ç¥¨å›¾æ ‡æ—¶ï¼Œæ‰å¯ä»¥è¾“å…¥æ”¶é“¶å°å•è¯
â€¢ è‹¥æ”¶é“¶å°å‰é¡¾å®¢ä»æ˜¾ç¤ºé£Ÿç‰©å›¾æ ‡æˆ–é«˜äº®è¯ï¼Œåˆ™å°šæœªè¿›å…¥ä»˜æ¬¾é˜¶æ®µï¼Œä¸å¯æ”¶é“¶ï¼

â¸»

ğŸ­ è€é¼ æœºåˆ¶ï¼š
â€¢ çº¢åœ°æ¯¯åŒºåŸŸå¯èƒ½å‡ºç°è€é¼ 
â€¢ è€é¼ å¤´é¡¶æ˜¾ç¤ºä¸€ä¸ªé«˜äº®çš„ä¸¤å­—æ¯å•è¯ï¼Œè¾“å…¥è¯¥è¯å¯å‡»é€€è€é¼ 
â€¢ æœ‰è€é¼ æ—¶ä¼˜å…ˆå‡»é€€è€é¼ 

â¸»

â›“ï¸ è¯·ä½¿ç”¨ Chain-of-Thought é£æ ¼è¿›è¡Œæ¨ç†

ä½ å¿…é¡»åˆ†æå½“å‰çŠ¶æ€åå†æ‰§è¡ŒåŠ¨ä½œã€‚åœ¨æ¯ä¸ª â€œstepsâ€ é¡¹ä¸­åŠ å…¥ â€œreasoningâ€ å­—æ®µï¼Œè¯´æ˜ï¼š
â€¢ ä¸ºä»€ä¹ˆé€‰æ‹©æ­¤æ“ä½œ
â€¢ ä¸ºä»€ä¹ˆä¸æ˜¯æ”¶é“¶æˆ–å…¶ä»–è¯
â€¢ ç‰¹åˆ«è¯´æ˜ä¸ºä»€ä¹ˆä¸èƒ½è¾“å…¥æŸäº›é«˜äº®è¯ï¼ˆä¾‹å¦‚æ”¶é“¶å°ã€æœºå™¨ï¼‰

â¸»

ğŸ§­ åŒºåŸŸåˆ¤æ–­è¯´æ˜ï¼ˆç”¨äºè¯åˆ†ç±»ï¼‰ï¼š

è¿”å›çš„æ‰€æœ‰å•è¯éœ€æŒ‰ç…§ä½ç½®å½’ç±»ä¸ºä»¥ä¸‹åŒºåŸŸï¼š

åŒºåŸŸåç§°    åˆ¤æ–­æ ‡å‡†
â€œcustomerâ€  é¡¾å®¢å¤´åƒä¸Šæ–¹å‡ºç°çš„é«˜äº®è¯ï¼Œç”¨äºä¸Šèœ
â€œcashierâ€   å±å¹•ä¸­åå·¦æ”¶é“¶å°åŒºåŸŸï¼Œé è¿‘ä¸­éƒ¨é€šé“
â€œcoffee_machineâ€    å’–å•¡æœºå‘¨å›´ï¼Œé€šå¸¸ä¼´éšæ•°å­—ï¼ˆå¦‚ 0ã€1ï¼‰
â€œfood_stationâ€  é£ŸæåŒºåŸŸï¼ˆæŠ«è¨ã€é”…ã€æ²¹é”…ç­‰ï¼‰
â€œotherâ€ æ— æ³•å½’ç±»æˆ–ä½ç½®æ¨¡ç³Š

â¸»

âœ… JSON è¿”å›æ ¼å¼ç¤ºä¾‹ï¼š

{
    â€œdescriptionâ€: â€œå·¦ä¸Šè§’æœ‰å·²å®Œæˆçš„æŠ«è¨ï¼›ä¸­å¤®æ¡Œæœ‰ä¸€ä¸ªé¡¾å®¢å¤´é¡¶æ˜¾ç¤ºé«˜äº®è¯ â€˜railâ€™ï¼Œä½†è¯¥è¯ä½äºæ”¶é“¶å°ï¼Œä¸æ˜¯ä¸Šèœè¯ï¼›å’–å•¡æœºé™„è¿‘æœ‰ â€˜coalâ€™ å’Œ â€˜threadâ€™ï¼›æ²¡æœ‰è€é¼ ï¼›æ— å®¢æˆ·å¤´é¡¶é’ç¥¨å›¾æ ‡ï¼›åº”å¼€å§‹åˆ¶ä½œè®¢å•ã€‚â€,
    â€œwordsâ€: [
        { â€œtextâ€: â€œrailâ€, â€œareaâ€: â€œcashierâ€ },
        { â€œtextâ€: â€œcoalâ€, â€œareaâ€: â€œcoffee_machineâ€ },
        { â€œtextâ€: â€œthreadâ€, â€œareaâ€: â€œcoffee_machineâ€ },
        { â€œtextâ€: â€œsteelâ€, â€œareaâ€: â€œfood_stationâ€ }
    ],
    â€œcashâ€: â€œrailâ€,
    â€œmouseâ€: false,
    â€œorderâ€: â€œæŠ«è¨â€,
    â€œstepsâ€: [
        {
        â€œactionâ€: â€œåˆ¶ä½œå’–å•¡â€,
        â€œinputâ€: â€œthreadâ€,
        â€œreasoningâ€: â€œthread ä½äºå’–å•¡æœºåŒºåŸŸï¼Œå½“å‰å’–å•¡æ•°é‡ä¸º 1ï¼Œå¯åˆ¶ä½œä¸€æ¯ï¼›é¡¾å®¢å¤´é¡¶æœªå‡ºç°é«˜äº®è¯ï¼Œå› æ­¤å°šæœªå¯ä¸Šèœï¼›æ”¶é“¶å°ä¸Šçš„ â€˜railâ€™ ä¸æ˜¯ä¸Šèœè¯ï¼Œä¹Ÿæœªåˆ°ä»˜æ¬¾é˜¶æ®µã€‚â€
        }
    ]
}"""

    def analyze_screenshot(self, image_url: str) -> Optional[any]:
        """åˆ†ææ¸¸æˆæˆªå›¾å¹¶è¿”å›æ¸¸æˆè®¡åˆ’ã€‚

        Args:
            image_url (str): å›¾ç‰‡çš„ URL

        Returns:
            Optional[any]: æ¸¸æˆè®¡åˆ’ï¼Œå¦‚æœåˆ†æå¤±è´¥åˆ™è¿”å› None
        """
        print(f"\nä½¿ç”¨å›¾ç‰‡: {image_url}")

        response = self.client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",
                    "content": self.system_prompt
                },
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": "è¯·åˆ†æè¿™ä¸ªæ¸¸æˆæˆªå›¾ï¼Œå‘Šè¯‰æˆ‘å½“å‰çš„è®¢å•çŠ¶æ€ï¼Œå¹¶ç»™å‡ºå…·ä½“çš„æ“ä½œæ­¥éª¤ã€‚"
                        },
                        {
                            "type": "image_url",
                            "image_url": {"url": image_url}
                        }
                    ]
                }
            ],
            max_tokens=1000,
            temperature=0
        )

        print("\nGPT å“åº”:")
        content = response.choices[0].message.content
        print(content)

        try:
            # å°è¯•åœ¨å“åº”ä¸­æ‰¾åˆ° JSON éƒ¨åˆ†
            json_start = content.find('{')
            json_end = content.rfind('}') + 1
            if json_start != -1 and json_end != -1:
                json_str = content[json_start:json_end]
                plan = json.loads(json_str)
                # å–å¾—æ‰€æœ‰input
                inputs = [step['input'] for step in plan['steps']]
                return inputs
            else:
                print("æœªæ‰¾åˆ° JSON æ•°æ®")
                return None
        except json.JSONDecodeError as e:
            print(f"JSON è§£æé”™è¯¯: {e}")
            return None
        except Exception as e:
            print(f"åˆ†ææˆªå›¾æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            return None

    def execute_plan(self, plan: Dict) -> bool:
        """
        æ‰§è¡Œæ“ä½œè®¡åˆ’
        
        Args:
            plan (Dict): æ“ä½œè®¡åˆ’
            
        Returns:
            bool: æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
        """
        # TODO: å®ç°è®¡åˆ’æ‰§è¡Œé€»è¾‘
        return True 